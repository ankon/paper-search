<!doctype html>
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-list/iron-list.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-collapse-item/paper-collapse-item.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-header-panel/paper-header-panel.html">
<link rel="import" href="../paper-toolbar/paper-toolbar.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-item/paper-item-body.html">
<link rel="import" href="../paper-styles/paper-styles.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../neon-animation/animations/fade-in-animation.html">
<link rel="import" href="../neon-animation/animations/fade-out-animation.html">

<!--
Dialog with which the user can filter the result set

@demo demo/paper-filter-dialog.html
-->
<dom-module id="paper-filter-dialog">

	<template>

		<style>
			.dialog {
		    	@apply(--paper-filter-dialog);
		    	--paper-dialog-background-color: var(--paper-filter-dialog-background-color);
			}

			paper-toolbar {
				@apply(--paper-filter-toolbar);
				--paper-toolbar-background: var(--paper-filter-toolbar-background);
			}

			.dialog,paper-header-panel {
				@apply(--layout-fit);
				padding: 0px;
			}

			paper-header-panel {
				margin: 0;
			}

			.filters,.value {
				background: white;
			}

			.filter {
				border-bottom: 1px solid var(--divider-color);
			}

			.filter,.value {
				cursor: pointer;
			}

			/** Workaround for IE11 to center column */
			.filter-body {
				height: 1px;
			}

			/**
			 * Workaround for IE11 to center column
			 * @see https://github.com/PolymerElements/paper-item/pull/65/commits/b41815d6f147a52755fc6db188a3f32a329640ee
			 */
			.value-holder {
				@apply(--layout-vertical);
			}

			.nrResults {
				color: var(--secondary-text-color);
			}
		</style>

		<paper-dialog id="dialog" class="dialog" entry-animation="fade-in-animation" exit-animation="fade-out-animation">
			<paper-header-panel mode="seamed">
				<paper-toolbar>
					<paper-icon-button on-tap="close" icon="close"></paper-icon-button>
					<span class="title"></span>
					<paper-button on-tap="_tapReset" class="reset" hidden$="[[!_hasSelectedFilters]]">[[resetButton]]</paper-button>
					<paper-button on-tap="_tapApply" dialog-confirm>[[saveButton]]</paper-button>
				</paper-toolbar>

				<div class="filters">
					<template is="dom-repeat" items="[[filters]]" as="filter">
						<paper-collapse-item class="filter" header="[[filter.name]]">
							<template is="dom-repeat" items="[[filter.values]]" as="filterValue">
								<div class="value-holder">
									<paper-item class="value">
										<paper-checkbox class="filter-value" data-filter-id$="[[filter.id]]" name="[[filterValue.id]]" checked="[[_isSelectedFilterValue(filter, filterValue, _selectedFilters)]]" on-checked-changed="_updateSelectedFilterValue"></paper-checkbox>
										<div>
											[[filterValue.name]]
											<span class="nrResults" hidden="[[!filterValue.count]]">([[filterValue.count]])</span>
										</div>
									</paper-item>
								</div>
							</template>
						</paper-collapse-item>
					</template>
				</div>
			</paper-header-panel>
		</paper-dialog>
	</template>
</dom-module>

<script>

(function() {

	Polymer({
		is: 'paper-filter-dialog',

		/**
		 * Fired when the user requests to save the filter selection
		 *
		 * @event save
		 */

		properties: {
			/**
			 * All filters from which the user can choose
			 */
			filters: Array,
			/**
			 * All filters that have been selected by the user, e.g. `{ age: [ "child", "teen" ] }`
			 */
			selectedFilters: {
				type: Object,
				notify: true,
				value: {}
			},

			/**
			 * Text for the reset button. Use this property to localize the element.
			 */
			resetButton: {
				type: String,
				value: 'Reset'
			},

			/**
			 * Text for the save button. Use this property to localize the element.
			 */
			saveButton: {
				type: String,
				value: 'Save filters'
			},

			/**
			 * Label shown if no values are selected for a filter. Use this property to localize the element.
			 */
			noValuesLabel: {
				type: String,
				value: 'No filters yet'
			},

			/**
			 * Internal copy that is changed. Copied back to original variable only once the user clicks on [Apply]
			 */
			_selectedFilters: {
				type: Object,
				value: {}
			},
			_selectedFilter: Object,
			_hasSelectedFilters: {
				type: Boolean,
				readOnly: true,
			}
		},

		observers: [
			'_updateHasSelectedFilters(_selectedFilters)',
			'_updateHasSelectedFilters(_selectedFilters.*)'
		],

		// Public methods
		/**
		 * Opens the filter dialog
		 */
		open: function() {
			// Attach dialog to the body to ensure it's on top of all existing overlays
			// XXX - Known issue: this generates addEventListener errors from a11y
			Polymer.dom(document.body).appendChild(this);

			// Clone selected filters, so it can be changed without touching the external property				
			this._selectedFilters = Object.assign({}, this.selectedFilters);

			// Wait until dialog is added to the DOM (required for Safari)
			setTimeout(function() {
				this.$.dialog.open();
			}.bind(this), 1);
		},

		close: function() {
			this.$.dialog.close();
		},

		_tapReset: function(e) {
			this._selectedFilters = {};
		},
		_tapApply: function(e) {
			function copyNonEmpty(selectedFilters) {
				return Object.keys(selectedFilters).reduce(function(result, key) {
					if (selectedFilters[key].length > 0) {
						result[key] = selectedFilters[key];
					}
					return result;
				}, {});
			}

			// Copy the non-empty keys back.
			this.selectedFilters = copyNonEmpty(this._selectedFilters);

			this.fire('save');
		},

		_computeHasSelectedFilters: function(selectedFilters) {
			return Object.keys(selectedFilters).reduce(function(result, selectedFilterId) {
				return result || selectedFilters[selectedFilterId].length !== 0;
			}, false);
		},
		_updateHasSelectedFilters: function(ignoredChangeOrObject) {
			// Ignore the actual change, and recalculate the value.
			// XXX: Polymer actually calls this sometimes with undefined, so ignore those (documented behavior)
			if (ignoredChangeOrObject) {
				this._set_hasSelectedFilters(this._computeHasSelectedFilters(this._selectedFilters));
			}
		},
		_isSelectedFilterValue: function(filter, value, selectedFilters) {
			return filter.id in selectedFilters && selectedFilters[filter.id].indexOf(value.id) !== -1;
		},
		_updateSelectedFilterValue: function(e) {
			var checkbox = e.target;
			var filterId = checkbox.getAttribute('data-filter-id');
			if (!filterId) {
				// This happens when the dialog is created, somehow polymer calls is BEFORE the attribute itself
				// is set. Ignore ...
				return;
			}
			var valueId = checkbox.name;
			
			// Recreate the filter values. Note that this produces empty arrays when all values get removed.
			var existingFilterValues = this._selectedFilters[filterId] || [];
			var acceptedOne = false;
			var filterValues = existingFilterValues.concat(valueId).filter(function(v) {
				if (v !== valueId) {
					// Ok: not looking at this value at all.
					return true;
				}

				if (!acceptedOne && e.target.checked) {
					// Ok: we're looking at this value, and it should be included. Include one.
					acceptedOne = true;
					return true;
				}

				// Filter out: either the value isn't checked, or we've seen it before.
				return false;
			});

			// Set if this is a new value, notifying all observers.
			// Note that we ignore changes that merely produced a new array, but kept all values (up to order) identical.
			if (existingFilterValues != filterValues) {
				this.set(`_selectedFilters.${filterId}`, filterValues);
			}
		},
		/**
		 * Create a "friendly" summary of the selected filter values.
		 */
		_getSelectedValuesNames: function(filter, selectedFilters) {
			var selectedValueIds = selectedFilters[filter.id];
			if (!selectedValueIds || selectedValueIds.length === 0 || filter.values.length === 0) {
				return this.noValuesLabel;
			}

			var names = filter.values.filter(function(value) {
				return selectedValueIds.indexOf(value.id) !== -1;
			}).map(function(value) {
				return value.name;
			});

			return names.length > 0 ? names.join(', ') : this.noValuesLabel;
		}
	});

})();

</script>
